@let $dataResult = _dataResult();
@let $pageable = pageable();

@let $pageIndex = _lastRequest?.page?.index ?? 1;

@let $data = $dataResult?.data;
@let $anyRecords = $data && $data.length > 0;
@let $totalRecordsCount = $dataResult?.total;
@let $firstRecord = $pageable ? ($pageable.pageSize! * ($pageIndex - 1) + 1) : 1;
@let $lastRecord = $data ? $firstRecord + $data.length - 1 : 1;

@let $isLoading = _dataSource.isLoading();
@let $isFirstLoad = $dataResult == undefined;

@let $columnsCount = _columns.length + (showRowNumbers() ? 1 : 0);
@let $tableLocale = _ls.get()?.definition?.components?.table;

<div class="table-responsive" [style.height]="height()" [class.table-scrollable]="height()! > 0">
  <table class="table" [ngClass]="tableClass()">
    @if (caption()) {
      <!-- <caption>{{caption()}}</caption> -->
    }

    @if (showHeader()) {
      <thead [ngClass]="headerClass()">
        <tr>
          @if (_detailRow) {
            <th></th>
          }

          @if (showRowNumbers()) {
            <th class="row-number text-muted">#</th>
          }

          @for (col of _columns; track $index) {
            <th>{{ col.title }}</th>
          }
        </tr>
      </thead>
    }

    @if (filterable()) {
      <thead>
        <tr>
          @if (_detailRow) {
            <th></th>
          }

          @if (showRowNumbers()) {
            <th></th>
          }

          @for (col of _columns; track $index) {
            <!-- <th>
                    @if(col.filterable) {
                    @if(col.type == 'text') {
                    <input [name]="'datatablecol-' + col.field"
                           type="text"
                           [maxlength]="50"
                           class="form-control form-control-sm"
                           [(ngModel)]="col.filterValue"
                           (keydown.enter)="load()">
                    }@else if(col.type == 'number') {
                    <input [name]="'datatablecol-' + col.field"
                           type="number"
                           class="form-control form-control-sm"
                           [(ngModel)]="col.filterValue"
                           (keydown.enter)="load()">
                    }
                    }
                </th> -->
          }
        </tr>
      </thead>
    }

    <tbody>
      @if ($isLoading && $isFirstLoad && loadingIndicator()) {
        <tr class="ng0-table-loading-row">
          <td [attr.colspan]="$columnsCount">
            @switch (loadingIndicator()) {
              @case ('spinner') {
                <div class="text-center">
                  <div class="spinner-border" role="status"></div>
                </div>
              }
              <!-- @case ('placeholder') {
                  <p class="text-secondary placeholder-glow mb-0">
                    <span class="placeholder col-3"></span>
                    <span class="placeholder col-4"></span>
                    <span class="placeholder col-4"></span>
                    <span class="placeholder col-6"></span>
                    <span class="placeholder col-8"></span>
                  </p>
                } -->
            }
          </td>
        </tr>
      } @else {
        @if ($data) {
          @if ($data.length > 0) {
            @for (row of $data; track $index) {
              <tr [class.table-active]="isRowExpanded(row)">
                @if (_detailRow) {
                  <td class="detail-row-expander">
                    @if (_detailRow.showCallback == null || _detailRow.showCallback(row)) {
                      <button class="btn" (click)="_onToggleRowDetailClick(row)">
                        @if (isRowExpanded(row)) {
                          <i class="far fa-minus"></i>
                        } @else {
                          <i class="far fa-plus"></i>
                        }
                      </button>
                    }
                  </td>
                }

                @if (showRowNumbers()) {
                  <td class="ng0-table-row-number">
                      {{ $firstRecord + $index }}
                  </td>
                }

                @for (col of _columns; track $index) {
                  <td
                    [ngClass]="col.cellClass"
                    [class.shrinked]="col.shrink"
                    [class.fw-bold]="col.bold"
                  >
                    @if (col.template) {
                      <ng-container
                        *ngTemplateOutlet="col.template; context: { $implicit: row }"
                      ></ng-container>
                    } @else if (col.field) {
                      @let cellValue = _getCellValue(row, col);

                      @if ((cellValue === null || cellValue === undefined) && col.emptyCellText()) {
                        {{ col.emptyCellText() }}
                      } @else {
                        @if (col.type()) {
                          @let type = $any(col.type());

                          @if (type == "date" || type.date) {
                            {{ cellValue | ng0Date }}
                          } @else if (type == "number" || type.number) {
                            {{ cellValue | number }}
                          } @else if (type == "currency") {
                            {{ cellValue | currency }}
                          } @else if (type.enum) {
                            {{ cellValue | ng0TranslateEnum: type.enum : type.returnEnumAsFallback }}
                          } @else if (type.boolean || type == "boolean") {
                            {{ cellValue | ng0LocalizeBool: type.boolean.false ?? "false" : type.boolean.false ?? "true" }}
                          }
                        } @else {
                          {{ cellValue }}
                        }
                      }
                    }
                  </td>
                }
              </tr>

              @if (_detailRow && isRowExpanded(row)) {
                <tr class="detail-row">
                  <td
                    [attr.colspan]="_columns.length + (showRowNumbers() ? 1 : 0) + 1"
                    class="ps-2 pb-4"
                  >
                    <ng-container
                      *ngTemplateOutlet="_detailRow.templateRef; context: { $implicit: row }"
                    ></ng-container>
                  </td>
                </tr>
              }
            }
          } @else {
            <tr class="ng0-table-no-records-row">
              <td [attr.colSpan]="$columnsCount" class="text-center p-2">
                {{ $tableLocale?.noRecords ?? 'No Records.' }}
              </td>
            </tr>
          }
        } @else if (_lastError) {
          <tr class="ng0-table-error-row">
            <td [attr.colSpan]="$columnsCount" class="p-2">
              <div class="d-flex align-items-baseline">
                <span>{{ $tableLocale?.loadError ?? 'Error loading data.' }} </span>
                <button (click)="load()" class="btn btn-warning ms-auto">
                  {{ "retry" | ng0Translate }}
                </button>
              </div>
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>

<div class="ng0-table-footer d-flex align-items-baseline">
  @if ($pageable && $pageable.showPagingControls && $anyRecords && $totalRecordsCount! > 0) {
    <div class="ng0-table-pagination me-2">
      <ng0-pagination
        class="mb-0 d-inline-block"
        [showFirstLastButtons]="$pageable.showFirstLastButtons == true"
        [showNextPreviousButtons]="$pageable.showNextPreviousButtons == true"
        [totalRecords]="$totalRecordsCount!"
        [pageSize]="$pageable.pageSize!"
        [selectedPage]="$pageIndex"
        (itemClick)="_onPageChange($event)"
        [maxVisiblePages]="$pageable.maxVisiblePages!"
      >
        <ng-container ngProjectAs="first">
          <ng-content select="paging-first">
            {{ "first" | ng0Translate }}
          </ng-content>
        </ng-container>

        <ng-container ngProjectAs="last">
          <ng-content select="paging-last">
            {{ "last" | ng0Translate }}
          </ng-content>
        </ng-container>

        <ng-container ngProjectAs="next">
          <ng-content select="paging-next">
            {{ "next" | ng0Translate }}
          </ng-content>
        </ng-container>

        <ng-container ngProjectAs="previous">
          <ng-content select="paging-previous">
            {{ "previous" | ng0Translate }}
          </ng-content>
        </ng-container>
      </ng0-pagination>
    </div>

    @if ($pageable.showPageSizeOptions || $pageable.showPageSizeOptions == undefined) {
      <div class="ng0-table-paging-options">
        <select name="pageSizeOptions" class="form-select w-auto d-inline-block">
          <option [ngValue]="10" selected>10</option>
        </select>
      </div>
    }

    @if ($pageable.showPagingInfo == undefined || $pageable.showPagingInfo) {
      <div class="ng0-table-paging-info ms-auto">
        <ng-content select="paging-info">
          {{
            _pagingFormatter({firstRecord: $firstRecord, lastRecord: $lastRecord, totalRecords: $totalRecordsCount!, currentPage: $pageIndex!})
          }}
        </ng-content>
      </div>
    }
  }
</div>

@if ($isLoading && !$isFirstLoad && loadingCover()) {
  <div class="ng0-table-loading-cover text-center">
    @if (loadingCover() == 'spinner') {
      <div class="spinner-border" role="status"></div>
    }
  </div>
}
