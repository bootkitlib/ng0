@let $data = _dataResult?.data;
@let $pageIndex = _lastRequest?.page?.index;
@let $pagable = pageable();
@let $anyRecords = $data && $data.length > 0 ;

<div class="table-responsive" [style.height]="height()" [class.table-scrollable]="height()! > 0">
    <table class="table" [ngClass]="tableClass()">
        @if(caption()) {
        <!-- <caption>{{caption()}}</caption> -->
        }

        <thead *ngIf="showHeader" [ngClass]="headerClass()">
            <tr>
                <th *ngIf="_detailRow"></th>
                <th *ngIf="showRowNumbers()" class="row-number text-muted">#</th>
                <th *ngFor="let col of _columns">{{col.title}}</th>
            </tr>
        </thead>
        <thead *ngIf="filterable()">
            <tr>
                <th *ngIf="_detailRow"></th>

                @if(showRowNumbers()) {
                <th></th>
                }

                <th *ngFor="let col of _columns">
                    @if(col.filterable) {
                    @if(col.type == 'text') {
                    <input [name]="'datatablecol-' + col.field"
                           type="text"
                           [maxlength]="50"
                           class="form-control form-control-sm"
                           [(ngModel)]="col.filterValue"
                           (keydown.enter)="load()">
                    }@else if(col.type == 'number') {
                    <input [name]="'datatablecol-' + col.field"
                           type="number"
                           class="form-control form-control-sm"
                           [(ngModel)]="col.filterValue"
                           (keydown.enter)="load()">
                    }
                    }
                </th>
            </tr>
        </thead>

        <tbody>
            <ng-container *ngIf="$data && $data.length! > 0">
                <ng-container *ngFor="let row of $data; let i=index">
                    <tr [class.table-active]="isRowExpanded(row)">
                        <td class="detail-row-expander" *ngIf="_detailRow">
                            <button class="btn" (click)="_onToggleRowDetailClick(row)"
                                    *ngIf="_detailRow.showCallback == null || _detailRow.showCallback(row)">
                                <ng-template [ngIf]="isRowExpanded(row)" [ngIfElse]="collapse"><i
                                       class="far fa-minus"></i></ng-template>
                                <ng-template #collapse><i class="far fa-plus"></i> </ng-template>
                            </button>
                        </td>

                        <td class="row-number text-muted" *ngIf="showRowNumbers()">
                            @if($pageIndex != undefined) {
                            {{pageable().pageSize! * $pageIndex + i + 1}}
                            }@else {
                            }
                        </td>

                        <td *ngFor="let col of _columns" [ngClass]="col.cellClass" [class.shrinked]="col.shrink"
                            [class.fw-bold]="col.bold">
                            @if(col.template){
                            <ng-template [ngIf]="col.template">
                                <ng-container
                                              *ngTemplateOutlet="col.template; context: {$implicit: row}"></ng-container>
                            </ng-template>
                            }@else if(col.field){
                            @let cellValue = _getCellValue(row, col);
                            <div
                                 [class.badge]="col.badge"
                                 [class.text-bg-primary]="col.badge?.primary && cellValue === col.badge?.primary"
                                 [class.text-bg-secondary]="col.badge?.secondary && cellValue === col.badge?.secondary"
                                 [class.text-bg-success]="col.badge?.success && cellValue === col.badge?.success"
                                 [class.text-bg-light]="col.badge && cellValue !== col.badge.success && cellValue !== col.badge.secondary  && cellValue !== col.badge.success ">

                                <ng-container *ngIf="col.type=='text'">
                                    {{cellValue}}
                                </ng-container>
                                <ng-container *ngIf="col.type=='date'">
                                    <span class="date-time">{{cellValue | ng0Date}}</span>
                                </ng-container>
                                <ng-container *ngIf="col.type=='number'">
                                    {{cellValue | number}}
                                </ng-container>
                                <ng-container *ngIf="col.type=='currency'">
                                    {{cellValue | number}}
                                </ng-container>
                                <ng-container *ngIf="$any(col?.type)?.enum">
                                    {{cellValue | ng0TranslateEnum:$any(col.type).enum}}
                                </ng-container>
                                <!-- <ng-container *ngIf="$any(col?.type)?.boolean">
                                    {{cellValue | ng0Bool:$any(col.type).boolean}}
                                </ng-container> -->
                                <ng-container *ngIf="$any(col?.type)?.currency">
                                    {{cellValue | currency:$any(col?.type)?.currency}}
                                </ng-container>

                                <ng-container *ngIf="cellValue == null && col.emptyCellText">
                                    {{col.emptyCellText}}
                                </ng-container>
                            </div>
                            }
                        </td>
                    </tr>

                    <tr class="detail-row" *ngIf="_detailRow && isRowExpanded(row)">
                        <td [attr.colspan]="_columns.length + (showRowNumbers() ? 1 : 0) + 1" class="ps-2 pb-4">
                            <ng-container *ngTemplateOutlet="_detailRow.templateRef; context: {$implicit: row}">
                            </ng-container>
                        </td>
                    </tr>
                </ng-container>

            </ng-container>

            <tr *ngIf="$data?.length === 0">
                <td [colSpan]="_columns.length + (showRowNumbers() ? 1 : 0)" class="text-center text-muted small p-2">
                    {{'noRecords' | ng0Translate}}
                </td>
            </tr>
        </tbody>
    </table>
</div>


<div class="ng0-table-footer d-flex align-items-baseline">
    @if($pagable && $pagable.showPagingControls && $anyRecords) {
    @let firstRecord = $pagable.pageSize! * ($pageIndex! - 1) + 1;
    @let lastRecord = firstRecord + $data.length - 1;
    @let totalRecords = _dataResult?.total!;

    <div class="ng0-table-paging-pages me-2">
        <ng0-pagination class="mb-0 d-inline-block"
                        [showFirstLastButtons]="$pagable.showFirstLastButtons == true"
                        [showNextPreviousButtons]="$pagable.showNextPreviousButtons == true"
                        [totalRecords]="_dataResult?.total!"
                        [pageSize]="pageable().pageSize!"
                        [selectedPage]="$pageIndex"
                        (itemClick)="_onPageChange($event)"
                        [maxVisiblePages]="$pagable.maxVisiblePages!">

            <ng-container ngProjectAs="first">
                <ng-content select="paging-first">
                    {{'first' | ng0Translate}}
                </ng-content>
            </ng-container>

            <ng-container ngProjectAs="last">
                <ng-content select="paging-last">
                    {{'last' | ng0Translate}}
                </ng-content>
            </ng-container>

            <ng-container ngProjectAs="next">
                <ng-content select="paging-next">
                    {{'next' | ng0Translate}}
                </ng-content>
            </ng-container>

            <ng-container ngProjectAs="previous">
                <ng-content select="paging-previous">
                    {{'previous' | ng0Translate}}
                </ng-content>
            </ng-container>
        </ng0-pagination>
    </div>

    @if($pagable.showPageSizeOptions || $pagable.showPageSizeOptions == undefined) {
    <div class="ng0-table-paging-options">
        <select name="pageSizeOptions" class=" form-select w-auto d-inline-block">
            <option [ngValue]="10" selected>10</option>
        </select>
    </div>
    }

    @if($pagable.showPagingInfo == undefined || $pagable.showPagingInfo) {
    <div class="ng0-table-paging-info ms-auto">
        <ng-content select="paging-info">
            {{_pagingFormatter({firstRecord, lastRecord, totalRecords, currentPage: $pageIndex! })}}
        </ng-content>
    </div>
    }

    }
</div>


<div *ngIf="_dataSource.loading" class="ng0-table-loading-cover text-center">
    <div class="spinner-border text-primary" role="status"></div>
</div>